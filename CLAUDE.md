# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```sh
# Build the provider
go build .

# Run unit tests
make test

# Run all tests including acceptance tests (requires running Pi-hole)
make testall

# Run a single test
go test ./internal/provider -run TestAccLocalDNS -v

# Lint
make lint

# Generate documentation
make docs
```

## Acceptance Test Setup

Acceptance tests require a running Pi-hole instance:

```sh
export PIHOLE_URL=http://localhost:8080
export PIHOLE_PASSWORD=test

make docker-run    # Starts Pi-hole in docker
make testall       # Run tests against it
```

To test a specific Pi-hole image: `TAG=nightly make docker-run`

## Architecture

This is a Terraform provider built with the HashiCorp Plugin SDK v2 (`terraform-plugin-sdk/v2`). It manages Pi-hole DNS and CNAME records through the [go-pihole](https://github.com/ryanwholey/go-pihole) client library.

### Provider Structure

- `main.go` - Entry point, serves the provider plugin
- `internal/provider/provider.go` - Provider schema and configuration (url, password, ca_file)
- `internal/provider/config.go` - Pi-hole client initialization with retryable HTTP

### Resources and Data Sources

| Type | File | Purpose |
|------|------|---------|
| Resource | `resource_dns_record.go` | Manages local DNS A records (domain -> IP) |
| Resource | `resource_cname_record.go` | Manages CNAME records (domain -> target) |
| Data Source | `data_source_dns_records.go` | Lists all DNS records |
| Data Source | `data_source_cname_records.go` | Lists all CNAME records |

### Test Pattern

Tests use the SDK v2 acceptance test framework with `resource.Test()`. Each resource has:
- `TestAcc*` functions for acceptance tests (require `TF_ACC=1`)
- Helper functions for config generation and existence checks
- Destroy check functions to verify cleanup

### Documentation Generation

Docs in `docs/` are auto-generated by tfplugindocs from:
- Schema descriptions in provider code
- Examples in `examples/`
- Templates in `templates/`

Run `make docs` after changing schema descriptions or examples.
