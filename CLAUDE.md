# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```sh
# Build the provider
go build .

# Run unit tests
make test

# Run all tests including acceptance tests (requires running Pi-hole)
make testall

# Run a single test
go test ./internal/provider -run TestAccLocalDNS -v

# Lint (requires golangci-lint)
make lint

# Generate documentation
make docs
```

## Acceptance Test Setup

Acceptance tests require a running Pi-hole instance:

```sh
export PIHOLE_URL=http://localhost:8080
export PIHOLE_PASSWORD=test

make docker-run    # Starts Pi-hole in docker
make testall       # Run tests against it
```

To test a specific Pi-hole image: `TAG=nightly make docker-run`

## Local Provider Installation

To test the provider manually with Terraform:

```sh
go build .
mkdir -p ~/.terraform.d/plugins/terraform.local/local/pihole/0.0.1/darwin_arm64/
cp terraform-provider-pihole ~/.terraform.d/plugins/terraform.local/local/pihole/0.0.1/darwin_arm64/terraform-provider-pihole_v0.0.1
```

Then reference it in Terraform config:
```hcl
terraform {
  required_providers {
    pihole = {
      source  = "terraform.local/local/pihole"
      version = "0.0.1"
    }
  }
}
```

Adjust `darwin_arm64` for your platform (see `.goreleaser.yml` for options).

## Architecture

This is a Terraform provider built with the HashiCorp Plugin SDK v2 (`terraform-plugin-sdk/v2`). It manages Pi-hole DNS and CNAME records through an internal Pi-hole v6 API client (`internal/pihole/`).

### Provider Structure

- `main.go` - Entry point, serves the provider plugin
- `internal/provider/provider.go` - Provider schema and configuration (url, password, ca_file, insecure_skip_verify)
- `internal/provider/config.go` - Pi-hole client initialization

### Internal Pi-hole Client

The `internal/pihole/` package provides a Pi-hole v6 API client:
- `client.go` - Client interface definition
- `types.go` - Shared types (Config, DNSRecord, CNAMERecord)
- `errors.go` - Sentinel errors (ErrDNSNotFound, ErrCNAMENotFound)
- `v6/client.go` - Pi-hole v6 API client implementation (session auth, HTTP methods)
- `v6/dns.go` - DNS A record operations (List, Get, Create, Delete)
- `v6/cname.go` - CNAME record operations (List, Get, Create, Delete)

### Resources and Data Sources

| Type | File | Purpose |
|------|------|---------|
| Resource | `resource_dns_record.go` | Manages local DNS A records (domain -> IP) |
| Resource | `resource_cname_record.go` | Manages CNAME records (domain -> target) |
| Data Source | `data_source_dns_records.go` | Lists all DNS records |
| Data Source | `data_source_cname_records.go` | Lists all CNAME records |

### Known Pi-hole API Limitations

The Pi-hole v6 API has some limitations that affect this provider:

1. **No in-place updates**: DNS and CNAME records cannot be updated in-place. Changing the IP (for DNS) or target (for CNAME) requires delete + create. The schema uses `ForceNew: true` to handle this.

2. **Race conditions on concurrent mutations**: The Pi-hole API can silently fail when multiple records are created/deleted concurrently. Both `resource_dns_record.go` and `resource_cname_record.go` use mutex locks (`dnsMutex`, `cnameMutex`) to serialize operations. See [issue #68](https://github.com/ryanwholey/terraform-provider-pihole/issues/68).

3. **Session limits**: Pi-hole has limited session slots. The provider registers a cleanup goroutine via `schema.StopContext` to logout sessions when Terraform exits.

### Test Pattern

Tests use the SDK v2 acceptance test framework with `resource.Test()`. Each resource has:
- `TestAcc*` functions for acceptance tests (require `TF_ACC=1`)
- Helper functions for config generation and existence checks
- Destroy check functions to verify cleanup

### Documentation Generation

Docs in `docs/` are auto-generated by tfplugindocs from:
- Schema descriptions in provider code
- Examples in `examples/`
- Templates in `templates/`

Run `make docs` after changing schema descriptions or examples.
